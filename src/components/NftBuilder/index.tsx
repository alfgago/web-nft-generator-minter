import { useEffect, useState } from "react"
import axios from "axios"
import { File, NFTStorage } from "nft.storage"

import SimpleHeader from "../Common/SimpleHeader"

import { useRequestStatus } from "./Hooks/useRequestStatus"
import ConfirmationStep from "./ConfirmationStep"
import DesignStep from "./DesignStep"
import FormStep from "./FormStep"
import { NftBuilderStyles } from "./NftBuilderStyles"
import StepsHeader from "./StepsHeader"

const NftBuilder = ({ artists }: any) => {
  const [activeStep, setActiveStep] = useState(1)
  const [uploading, setUploading] = useState(false)
  const [selectedArtist, setSelectedArtist] = useState(artists[0])
  const { requestStatus: contractDeployStatus, setRequestId } =
    useRequestStatus()

  const [formValues, setFormValues] = useState({
    name: "AUTOGENERATED",
    wallet: "",
    size: "100",
    passType: "Lottery",
    saleType: "Auction",
    price: "0.1",
    duration: "24",
    winners: "5",
    date: new Date(),
  })

  useEffect(() => {
    window.canvas = false
  }, [])

  const nextStep = () => {
    setActiveStep(activeStep + 1)
  }

  const previousStep = () => {
    setActiveStep(activeStep - 1)
  }

  const onFormSave = (values: any) => {
    nextStep()
    const sel = artists.find((obj: any) => obj.id == values.artist)
    setSelectedArtist(sel)
    setFormValues(values)
  }

  const submit = async (images: any) => {
    setUploading(true)
    const NFT_STORAGE_TOKEN = process.env.NEXT_PUBLIC_NFT_STORAGE_KEY ?? ""
    const client = new NFTStorage({ token: NFT_STORAGE_TOKEN })

    // Upload first image to use as preview
    const base64Response = await fetch(images[0])
    const blob = await base64Response.blob()
    const nftKey = await client.storeBlob(blob)

    // Creates the pass, to then associate NFTs to it
    const passResponse = await axios.post("/api/passes/create", {
      ...formValues,
      preview_image_url: nftKey + ".ipfs.nftstorage.link",
    })
    for (const i in images) {
      if (images[i]) {
        const base64Response = await fetch(images[i])
        const blob = await base64Response.blob()
        const nftKey = await client.storeBlob(blob)
        await axios.post("/api/nfts/create", {
          name: formValues.name + " " + i + 1,
          image_url: nftKey + ".ipfs.nftstorage.link",
          ipfs_token: nftKey,
          pass_id: passResponse.data.data.id,
        })
        console.log(i + ": " + nftKey)
      }
    }
    setUploading(false)
    /* const res = await fetch("/api/contracts", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formValues),
    })

    if (!res.ok) {
      const { err } = await res.json()
      alert("Error: " + err)
    }

    const { requestId } = await res.json()
    setRequestId(requestId)*/
  }

  return (
    <NftBuilderStyles>
      <SimpleHeader title="NFT Collection Generator" />
      <StepsHeader activeStep={activeStep} />
      <section className="steps">
        <div className="content">
          {activeStep == 1 && (
            <FormStep
              formValues={formValues}
              nextAction={onFormSave}
              artists={artists}
            />
          )}
          {activeStep == 2 && (
            <DesignStep
              nftName={formValues.name}
              nextAction={nextStep}
              previousAction={previousStep}
              artist={selectedArtist}
            />
          )}
          {activeStep == 3 && (
            <ConfirmationStep
              formValues={formValues}
              nextAction={submit}
              previousAction={previousStep}
              uploading={uploading}
            />
          )}
        </div>
      </section>
      {/* TODO - Show different display states */}
      {contractDeployStatus === "pending" && null}
      {contractDeployStatus === "succeeded" && null}
      {contractDeployStatus === "failed" && null}
    </NftBuilderStyles>
  )
}

export default NftBuilder
